{% extends 'staff_hunt_base.html' %}
{% load static %}
{% load humanize %}

{% block includes %}
  {{ block.super }}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@100..800&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.2/css/dataTables.bulma.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/4.0.0/css/fixedHeader.dataTables.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/5.0.0/css/fixedColumns.dataTables.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/2.0.2/js/dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/2.0.2/js/dataTables.bulma.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/4.0.0/js/dataTables.fixedHeader.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/5.0.0/js/dataTables.fixedColumns.js"></script>
  <script>
    htmx.config.useTemplateFragments = true;
  </script>
{% endblock includes %}

{% block staff_content %}
  <div class="progress-container"
       :class="sidebarOpen && 'sidebarOpen'"
       hx-ext="sse" sse-connect="{% url 'puzzlehunt:staff_events' %}"
  >
    <div id="tableKey" class="table-key">
      <ul>
        <li><span class="color-swatch" style="background: linear-gradient(to right, #ffffaa, #ffddaa, #ffbbaa, #ff9999);"></span>Unsolved</li>
        <li><span class="color-swatch" style="background-color: #aaffaa;"></span> Solved</li>
        <li><span class="border-swatch" style="border: 4px solid #ffdb26;"></span> 1 hint used</li>
        <li><span class="border-swatch" style="border: 4px solid #db5100;"></span> 2 hints used</li>
        <li><span class="border-swatch" style="border: 4px solid #000000;"></span> 3+ hints used</li>
        <li><strong>T: </strong>&nbsp; Last submission time</li>
        <li><strong>S: </strong>&nbsp; # of submissions</li>
      </ul>
    </div>
    <table id="progressTable" class="table is-narrow is-bordered">
      <thead>
        <tr>
          <th>Team Name</th>
          <th>Rank</th>
          {% for column in info_columns %}
            <th>{{ column.display_name }}</th>
          {% endfor %}
          {% for puzzle in puzzles %}
            <th>
              <div class="has-tooltip-arrow has-tooltip-bottom" data-tooltip="{{ puzzle.name }}">
                {{ puzzle.abbreviation }}<br>{{ puzzle.order_number }}
              </div>
            </th>
          {% endfor %}
        </tr>
        <tr>
          <th># Hints Used</th>
          <th>Rank</th>
          {% for column in info_columns %}
            <th>{{ column.display_name }}</th>
          {% endfor %}
          {% for puzzle in puzzles %}
            <th class="summary-cell"></th>
          {% endfor %}
        </tr>
        <tr>
          <th># Solves</th>
          <th>Rank</th>
          {% for column in info_columns %}
            <th>{{ column.display_name }}</th>
          {% endfor %}
          {% for puzzle in puzzles %}
            <th class="summary-cell"></th>
          {% endfor %}
        </tr>
        <tr>
          <th># Unlocks</th>
          <th>Rank</th>
          {% for column in info_columns %}
            <th>{{ column.display_name }}</th>
          {% endfor %}
          {% for puzzle in puzzles %}
            <th class="summary-cell"></th>
          {% endfor %}
        </tr>
        <tr>
          <th># Submissions</th>
          <th>Rank</th>
          {% for column in info_columns %}
            <th>{{ column.display_name }}</th>
          {% endfor %}
          {% for puzzle in puzzles %}
            <th class="summary-cell"></th>
          {% endfor %}
        </tr>
      </thead>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tableKey = document.getElementById('tableKey');
      const keyHeight = tableKey.offsetHeight;

      const table = new DataTable('#progressTable', {
        ajax: {
          url: '{% url "puzzlehunt:staff:progress_data" hunt.pk %}',
          dataSrc: 'data',
        },
        fixedHeader: {
          header: true,
          headerOffset: keyHeight,
          fixedPosition: false
        },
        fixedColumns: {
          left: 1
        },
        scrollX: true,
        scrollY: `calc(100vh - ${keyHeight + 270}px)`,
        scrollCollapse: true,
        order: [[1, 'asc']],
        columns: [
          { 
            data: 'team.name',
            title: 'Team',
            className: 'has-text-left',
            width: '200px',
            render: function(data, type, row) {
              return `<div style="max-width: 200px; white-space: normal; word-wrap: break-word;">${data}</div>`;
            }
          },
          {
            data: null,
            title: 'Rank',
            className: 'has-text-centered',
            render: function(data, type, row, meta) {
              return meta.row + 1;
            }
          },
          {% for column in info_columns %}
            {
              data: 'ranking_columns.{{ column.display_name }}',
              title: '{{ column.display_name }}',
              className: 'has-text-centered',
              {% if column.is_time %}
              render: function(data, type, row) {
                if (!data) {
                  return type === 'sort' ? '9999-12-31T23:59:59' : '';
                }
                const date = new Date(data);
                
                // Return ISO string for sorting
                if (type === 'sort') {
                  return data;
                }
                
                // Return formatted display value
                return `<div class="has-text-centered">` +
                       `<span class="puzzle-cell"><span class="mono">${date.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false})}</span></span><br>` +
                       `<span class="puzzle-cell"><span class="mono">${date.toLocaleDateString('en-US', {month: 'numeric', day: 'numeric'})}</span></span>` +
                       `</div>`;
              }
              {% endif %}
            },
          {% endfor %}
          {% for puzzle in puzzles %}
            {
              data: 'puzzles.{{ puzzle.pk }}',
              title: '{{ puzzle.abbreviation }}',
              defaultContent: '',
              render: function(data, type, row) {
                if (!data) {
                  return type === 'sort' ? '9999-12-31T23:59:59' : '';
                }
                
                // For sorting, use solve_time or last_submission
                if (type === 'sort') {
                  if (data.solve_time) return data.solve_time;
                  if (data.last_submission) return data.last_submission;
                  return '9999-12-31T23:59:59';
                }
                
                // Calculate background color and border style
                let bgColor = '';
                let borderStyle = 'padding: 4px;'; // Default padding to match border width
                
                if (data.solve_time) {
                  bgColor = 'background-color: #aaffaa;';
                } else {
                  const referenceTime = data.last_submission || data.unlock_time;
                  if (referenceTime) {
                    const timeSince = (new Date() - new Date(referenceTime)) / (1000 * 60 * 60); // hours
                    if (timeSince > 5) {
                      bgColor = 'background-color: #ff9999;';
                    } else if (timeSince > 3) {
                      bgColor = 'background-color: #ffbbaa;';
                    } else if (timeSince > 1) {
                      bgColor = 'background-color: #ffddaa;';
                    } else {
                      bgColor = 'background-color: #ffffaa;';
                    }
                  }
                }
                
                // Add border based on number of hints
                if (data.num_hints === 1) {
                  borderStyle = 'border: 4px solid #ffdb26;';
                } else if (data.num_hints === 2) {
                  borderStyle = 'border: 4px solid #db5100;';
                } else if (data.num_hints >= 3) {
                  borderStyle = 'border: 4px solid #000000;';
                }
                
                // For display, use the existing format with background color and border
                let content = `<div class="puzzle-cell-container" style="${bgColor} ${borderStyle}">`;
                if (data.solve_time) {
                  content += `<span class="puzzle-cell"><b>T:</b> <span class="mono">${new Date(data.solve_time).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false})}</span></span><br>`;
                  content += `<span class="puzzle-cell puzzle-cell-indent"><span class="mono">${new Date(data.solve_time).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric'})}</span></span>`;
                } else if (data.last_submission) {
                  content += `<span class="puzzle-cell"><b>T:</b> <span class="mono">${new Date(data.last_submission).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false})}</span></span><br>`;
                  content += `<span class="puzzle-cell puzzle-cell-indent"><span class="mono">${new Date(data.last_submission).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric'})}</span></span>`;
                }
                if (data.unlock_time) {
                  content += `<br><span class="puzzle-cell"><b>S:</b> <span class="mono">${String(data.num_submissions).padStart(2, ' ')}</span></span>`;
                }
                content += '</div>';
                return content;
              }
            },
          {% endfor %}
        ],
        paging: false,
        searching: false,
        info: false,
        layout: {
          topStart: null,
          topEnd: null,
          bottomStart: null,
          bottomEnd: null,
        },
        headerCallback: function(thead, data, start, end, display) {
          const api = new $.fn.dataTable.Api(this);
          updateHeaders(api);
        },
      });

      // Helper function to update all headers
      function updateHeaders(api) {
        const startCol = 2 + {{ info_columns|length }};
        const puzzleColumns = api.columns().indexes().toArray().slice(startCol);

        // Get all header rows
        const headerRows = $(api.table().header()).find('tr');
        
        // Set the metric names in the first column
        $(headerRows[1]).find('th:first').html('# Hints Used');
        $(headerRows[2]).find('th:first').html('# Solves');
        $(headerRows[3]).find('th:first').html('# Unlocks');
        $(headerRows[4]).find('th:first').html('# Submissions');
        
        // Clear the repeated headers in rows 2-5
        headerRows.slice(1, 5).each(function() {
          $(this).find('th').each(function(i) {
            if (i > 0 && i < startCol) {  // Skip the first column (i > 0)
              $(this).html('');
            }
          });
        });
        
        // Process each puzzle column
        puzzleColumns.forEach((colIdx, i) => {
          const columnData = api.column(colIdx).data().toArray();
          const actualColIdx = i + startCol;
          
          try {
            // Calculate summaries for this puzzle column
            let hints = 0, solves = 0, unlocks = 0, submissions = 0;
            
            columnData.forEach(d => {
              if (d) {
                hints += (d.num_hints || 0);
                solves += (d.solve_time ? 1 : 0);
                unlocks += (d.unlock_time ? 1 : 0);
                submissions += (d.num_submissions || 0);
              }
            });
            
            // Update each summary row with its respective value
            $(headerRows[1]).find(`th:eq(${actualColIdx})`).html(hints);
            $(headerRows[2]).find(`th:eq(${actualColIdx})`).html(solves);
            $(headerRows[3]).find(`th:eq(${actualColIdx})`).html(unlocks);
            $(headerRows[4]).find(`th:eq(${actualColIdx})`).html(submissions);
            
          } catch (error) {
            console.error('Error processing column:', colIdx, error);
          }
        });
      }
    });
  </script>
{% endblock %}
